<html>
    <head>
        <!-- jQuery 3.3.1 -->
        <script src="/local_modules/jquery/jquery-3.3.1.min.js"></script>
        
        <!-- Bootstrap 4.0 -->
        <script src="/local_modules/bootstrap-4.0.0/dist/js/bootstrap.min.js"></script>

        <!-- Bootstrap 4.0 CSS -->
        <link rel="stylesheet" href="/local_modules/bootstrap-4.0.0/dist/css/bootstrap.min.css">
        
        <!-- my stylesheet -->
        <link rel="stylesheet" href="/main.css">

        <!-- Cabin font -->
        <link href="https://fonts.googleapis.com/css?family=Cabin" rel="stylesheet">  
    </head>
    
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-sm bg-light navbar-light fixed-top">
                <a class="navbar-brand" href="/">Drew Graham</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <a class="nav-item nav-link active" href="/">Home <span class="sr-only">(current)</span></a>
                        <a class="nav-item nav-link" href="/games">Games</a>
                        <a class="nav-item nav-link" href="/about">About</a>
                        <a class="nav-item nav-link disabled" href="#">Blog (coming soon)</a>
                    </div>
                </div>
            </nav>

        <!-- page header -->
        <div class="container">
            <br>
            <div class="jumbotron horizontal-center bg-transparent">
                <div class="row">
                    <div class="col-xs-12">
                        <h1 id="name"></h1>
                        <h3 id="shortDescription"></h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- page body -->
        <div class="container">

            <!-- cover image of game -->
            <div class="row" id="cover-image">
                <br/>
            </div>
            <br/>

            <!-- link to playable game -->
            <div class="row" id="game-link">
                <br><br><br>
            </div>

            
            <!-- Grid of game screenshots -->
            <h3>Screenshots</h3> <br>
            <div class="row" id="thumbnail-grid">
            </div>
            

            <!-- game description-->
            <div class="game-description">
                <br>
                <div class="jumbotron">
                    <div class="game-description-text" id="description"></div>
                    <br>
                </div>
            </div>
          

        </div>
    </body>

    <script type="text/javascript">

        GetGameData();

        function GetGameData()
        {
            // get gameId from url query
            var urlParams = new URLSearchParams(window.location.search);
            var id = urlParams.get('gameId');
            if(id == null) {
                console.log("unable to get game data, parameter name not found");
                return;
            }
            console.log("getting data for game:" + id);

            $.ajax({
                type: "GET",
                url: "/getGameData",
                dataType: "text",
                data: {
                    gameId: id
                },
                
                success: function(msg){
                    // parse response into json
                    var json = JSON.parse(msg);
                    
                    if(json == null) {
                        console.log("could not parse response: " + msg);
                        return;
                    }
                    console.log(json);
                    
                    FillGameData(json);
                }
            });

        }
        
        // Fills divs with game data
        function FillGameData(json) {
            // get game data
            var name = json["name"];
            var description = json["description"];
            var shortDescription = json["shortDescription"];
            var coverImage = json["coverImage"];
            var playable = json["playable"];
            
            GenerateScreenshots(json);
            
            // Fill name
            $("#name").html("<h1>" + name + "</h1>");

            // Fill short description
            $("#shortDescription").html("<h5> " + shortDescription + "</h5>");

            // Fill cover image
            $("#cover-image").html("<img src=\"" + coverImage + "\" class=\"rounded mx-auto d-block\">" + "<br/>");
            
            // // Fill description (TODO: improve the way description headers are handled)
            $("#description").html("<h2>Description</h2>");
            
            // Cycle through sections of description
            for(var item in description) {
                console.log("adding description " + item);

                // add description header (ignore for "main" item)
                if(item != "main" && item != "Github") {
                    $("#description").append("<h2>" + item + "</h2>");
                }
                
                // Github link
                if(item == "Github") {
                    $("#description").append("<h3>Github: <a href=\"" + description[item] + "\">" + description[item] + "</a></h3>");
                    continue;
                }
                // add description body
                $("#description").append("<p>" + description[item] + "</p><hr/>");
            }
            
            // Fill link to game if playable
            if(playable) {
                var link = json["link"];
                console.log("game is playable, adding link: " + link);
                $("#game-link").append(
                    "<h3>Play game "
                        + "<b><a href=\"" + link + "\">here!</a></b>" + "</h3>"
                    + "<hr>");
            }
            else {
                // console.log("game not playable, hiding game-link section");

                // empty contents of game link div
                $("#game-link").empty();
            }
            
        }


        // Generates screenshots from response on page
        function GenerateScreenshots(json) {
            console.log("generating screenshots");
            // get images from json
            var images = json["images"];
            console.log(images);

            for(var imageKey in images) {
                // get image json object (contains image path and caption)
                var image = images[imageKey];
                
                // validate
                if(image == null) {
                    console.log("image object [" + imageKey + "] not found, continuing");
                    continue;
                }
                console.log("parsing image [" + imageKey + "]");

                // get image path and caption
                var imagePath = image["imagePath"];
                var caption = image["caption"];
                
                // validate
                if(imagePath == null || caption == null) {
                    console.log("Image could not be parsed: path (" + imagePath + "), caption (" + caption + ")");
                    continue;
                }
                
                // Create screenshot
                $("<div class=\"col-md-4\">" +
                    "<figure class=\"figure\">" +
                        "<a href=\"" + imagePath + "\">" +
                            "<img src=\"" + imagePath + "\" class=\"figure-img img-fluid rounded\" alt=\"A generic square placeholder image with rounded corners in a figure.\">" +
                        "</a>" +
                        "<figcaption class=\"figure-caption\">" + caption + "</figcaption>" +
                    "</figure>" +  
                "</div>").appendTo("#thumbnail-grid");
            }
        }

    </script>
    
</html>